<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modbus Browser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        .register-value {
            font-family: monospace;
        }

        .register-card {
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Modbus Browser</h1>
            <div>
                <button class="btn btn-info me-2" onclick="showConfig()">
                    <i class="bi bi-gear"></i> Show Config
                </button>
                <input type="file" id="configFile" class="d-none" accept=".json" onchange="uploadConfig(this)">
                <button class="btn btn-secondary me-2" onclick="document.getElementById('configFile').click()">
                    <i class="bi bi-upload"></i> Upload Config
                </button>
                <button class="btn btn-primary" hx-get="/api/servers" hx-target="#serverList" hx-swap="innerHTML">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Servers
                </button>
            </div>
        </div>

        <!-- Configuration Modal -->
        <div class="modal fade" id="configModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Server Configuration</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <pre id="configJson" class="bg-light p-3" style="max-height: 400px; overflow-y: auto;"></pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="downloadConfig()">Download
                            Config</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Server Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Add Modbus Server</h5>
            </div>
            <div class="card-body">
                <form id="addServerForm" hx-post="/api/servers" hx-target="#serverList" hx-swap="beforeend">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="serverId" class="form-label">Server ID</label>
                                <input type="text" class="form-control" id="serverId" name="id" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="serverAddress" class="form-label">Address</label>
                                <input type="text" class="form-control" id="serverAddress" name="address" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="serverPort" class="form-label">Port</label>
                                <input type="number" class="form-control" id="serverPort" name="port" value="502"
                                    required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label for="pollRate" class="form-label">Poll Rate (ms)</label>
                                <input type="number" class="form-control" id="pollRate" name="pollRate" value="1000"
                                    required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary d-block w-100">Add Server</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Server List -->
        <div id="serverListContainer">
            <div id="serverList" hx-get="/api/servers" hx-trigger="load">
            </div>
        </div>
    </div>

    <!-- Add Block Modal -->
    <div class="modal fade" id="addBlockModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Register Block</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBlockForm">
                        <input type="hidden" id="blockServerId">
                        <div class="mb-3">
                            <label for="blockType" class="form-label">Block Type</label>
                            <select class="form-select" id="blockType" required>
                                <option value="coil">Coil (0-9999)</option>
                                <option value="discrete">Discrete Input (10000-19999)</option>
                                <option value="input">Input Register (30000-39999)</option>
                                <option value="holding">Holding Register (40000-49999)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="blockStartAddress" class="form-label">Start Address</label>
                            <input type="number" class="form-control" id="blockStartAddress" required min="0" max="9999">
                        </div>
                        <div class="mb-3">
                            <label for="blockLength" class="form-label">Length</label>
                            <input type="number" class="form-control" id="blockLength" required min="1" max="125">
                            <small class="form-text text-muted">Max 125 registers per block</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addBlock()">Add Block</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Register Modal -->
    <div class="modal fade" id="addRegisterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Register</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addRegisterForm">
                        <input type="hidden" id="registerServerId">
                        <div class="mb-3">
                            <label for="registerType" class="form-label">Register Type</label>
                            <select class="form-select" id="registerType" required onchange="updateAddressRange(); updateFormatOptions()">
                                <option value="coil">Coil (0-9999)</option>
                                <option value="discrete">Discrete Input (10000-19999)</option>
                                <option value="input">Input Register (30000-39999)</option>
                                <option value="holding">Holding Register (40000-49999)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="registerName" class="form-label">Register Name</label>
                            <input type="text" class="form-control" id="registerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerAddress" class="form-label">Register Address</label>
                            <input type="number" class="form-control" id="registerAddress" required min="0" max="9999">
                            <small class="form-text text-muted" id="addressRange"></small>
                        </div>
                        <div class="mb-3">
                            <label for="registerFormat" class="form-label">Format</label>
                            <select class="form-select" id="registerFormat" required>
                                <option value="decimal">Decimal</option>
                                <option value="hex">Hexadecimal</option>
                                <option value="float">Float</option>
                                <option value="boolean">Boolean</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addRegister()">Add Register</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Add Modal -->
    <div class="modal fade" id="bulkAddModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Add Registers</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkAddForm">
                        <input type="hidden" id="bulkAddServerId">
                        <div class="mb-3">
                            <label for="bulkAddType" class="form-label">Register Type</label>
                            <select class="form-select" id="bulkAddType" required onchange="updateBulkAddFormatOptions()">
                                <option value="coil">Coil (0-9999)</option>
                                <option value="discrete">Discrete Input (10000-19999)</option>
                                <option value="input">Input Register (30000-39999)</option>
                                <option value="holding">Holding Register (40000-49999)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="bulkAddFormat" class="form-label">Default Format</label>
                            <select class="form-select" id="bulkAddFormat" required>
                                <option value="decimal">Decimal</option>
                                <option value="hex">Hexadecimal</option>
                                <option value="float">Float</option>
                                <option value="boolean">Boolean</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="bulkAddText" class="form-label">Register List (CSV format)</label>
                            <p class="text-muted">Format: name,address,format (optional)</p>
                            <p class="text-muted">If address is omitted, it will increment from the previous address.</p>
                            <textarea id="bulkAddText" class="form-control" rows="10" placeholder="register1,1000&#10;register2,1001&#10;register3,,hex"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="processBulkAdd()">Add Registers</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration modal management
        let configModal;
        let addBlockModal;
        let addRegisterModal;
        let bulkAddModal;

        document.addEventListener('DOMContentLoaded', function () {
            configModal = new bootstrap.Modal(document.getElementById('configModal'));
            addBlockModal = new bootstrap.Modal(document.getElementById('addBlockModal'));
            addRegisterModal = new bootstrap.Modal(document.getElementById('addRegisterModal'));
            bulkAddModal = new bootstrap.Modal(document.getElementById('bulkAddModal'));

            // Set default values
            document.getElementById('serverAddress').value = '127.0.0.1';
            document.getElementById('blockType').value = 'holding';
            document.getElementById('blockStartAddress').value = '0';
            document.getElementById('blockLength').value = '10';
            document.getElementById('registerType').value = 'holding';
            document.getElementById('bulkAddType').value = 'holding';

            updateAddressRange();
            updateFormatOptions();
            updateBulkAddFormatOptions();
        });

        function showConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('configJson').textContent = JSON.stringify(data, null, 2);
                    configModal.show();
                })
                .catch(error => {
                    alert('Error loading configuration: ' + error);
                });
        }

        function downloadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'modbus.json';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    alert('Error downloading configuration: ' + error);
                });
        }

        // Register configuration management
        let registerConfigs = [];

        function updateAddressRange() {
            const type = document.getElementById('registerType').value;
            const addressInput = document.getElementById('registerAddress');
            const addressRange = document.getElementById('addressRange');

            switch (type) {
                case 'coil':
                    addressInput.min = 0;
                    addressInput.max = 9999;
                    addressRange.textContent = 'Range: 0-9999';
                    break;
                case 'discrete':
                    addressInput.min = 0;
                    addressInput.max = 9999;
                    addressRange.textContent = 'Range: 10000-19999';
                    break;
                case 'input':
                    addressInput.min = 0;
                    addressInput.max = 9999;
                    addressRange.textContent = 'Range: 30000-39999';
                    break;
                case 'holding':
                    addressInput.min = 0;
                    addressInput.max = 9999;
                    addressRange.textContent = 'Range: 40000-49999';
                    break;
            }
        }

        function updateFormatOptions() {
            const type = document.getElementById('registerType').value;
            const format = document.getElementById('registerFormat');

            // Reset options
            format.innerHTML = '';

            if (type === 'coil' || type === 'discrete') {
                // For coils and discrete inputs, only boolean format makes sense
                format.innerHTML = '<option value="boolean">Boolean</option>';
            } else {
                // For input and holding registers, all formats are available
                format.innerHTML = `
                    <option value="decimal">Decimal</option>
                    <option value="hex">Hexadecimal</option>
                    <option value="float">Float</option>
                    <option value="boolean">Boolean</option>
                `;
            }
        }

        function addRegisterConfig() {
            const type = document.getElementById('registerType').value;
            const name = document.getElementById('registerName').value;
            const baseAddress = parseInt(document.getElementById('registerAddress').value);
            const format = document.getElementById('registerFormat').value;

            if (!name || isNaN(baseAddress)) {
                alert('Please fill in all fields');
                return;
            }

            // Calculate the actual Modbus address based on register type
            let address = baseAddress;
            switch (type) {
                case 'discrete':
                    address += 10000;
                    break;
                case 'input':
                    address += 30000;
                    break;
                case 'holding':
                    address += 40000;
                    break;
            }

            registerConfigs.push({
                name,
                address,
                format,
                type
            });
            updateRegisterConfigTable();
            document.getElementById('registerConfigForm').reset();
            updateAddressRange();
            updateFormatOptions();
        }

        function removeRegisterConfig(index) {
            registerConfigs.splice(index, 1);
            updateRegisterConfigTable();
        }

        function updateRegisterConfigTable() {
            const tbody = document.getElementById('registerConfigList');
            tbody.innerHTML = registerConfigs.map((config, index) => `
                <tr>
                    <td>${config.name}</td>
                    <td>${config.type}</td>
                    <td>${config.address}</td>
                    <td>${config.format}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeRegisterConfig(${index})">Remove</button>
                    </td>
                </tr>
            `).join('');
        }

        // Register block management
        let registerBlocks = [];

        function addRegisterBlock() {
            const type = document.getElementById('blockType').value;
            const startAddress = parseInt(document.getElementById('blockStartAddress').value);
            const length = parseInt(document.getElementById('blockLength').value);

            if (isNaN(startAddress) || isNaN(length)) {
                alert('Please fill in all fields');
                return;
            }

            // Calculate the actual Modbus address based on block type
            let address = startAddress;
            switch (type) {
                case 'discrete':
                    address += 10000;
                    break;
                case 'input':
                    address += 30000;
                    break;
                case 'holding':
                    address += 40000;
                    break;
            }

            registerBlocks.push({
                type,
                startAddress: address,
                length
            });
            updateRegisterBlockTable();
            document.getElementById('registerBlockForm').reset();
        }

        function removeRegisterBlock(index) {
            registerBlocks.splice(index, 1);
            updateRegisterBlockTable();
        }

        function updateRegisterBlockTable() {
            const tbody = document.getElementById('registerBlockList');
            tbody.innerHTML = registerBlocks.map((block, index) => `
                <tr>
                    <td>${block.type}</td>
                    <td>${block.startAddress}</td>
                    <td>${block.length}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeRegisterBlock(${index})">Remove</button>
                    </td>
                </tr>
            `).join('');
        }

        // Update the server form handler to include register blocks
        document.getElementById('addServerForm').addEventListener('htmx:afterRequest', function (evt) {
            if (evt.detail.successful) {
                // Create server config with register blocks and register configurations
                const serverId = document.getElementById('serverId').value;
                const config = {
                    servers: [{
                        id: serverId,
                        address: document.getElementById('serverAddress').value,
                        port: parseInt(document.getElementById('serverPort').value),
                        pollRate: parseInt(document.getElementById('pollRate').value)
                    }]
                };

                // Upload configuration
                fetch('/api/config/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            htmx.trigger('#serverList', 'load');
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error uploading config: ' + error);
                    });
            } else {
                alert('Error: ' + (evt.detail.xhr.response ? JSON.parse(evt.detail.xhr.response).error : 'Failed to add server'));
            }
        });

        // Handle config file upload
        function uploadConfig(input) {
            if (input.files && input.files[0]) {
                const formData = new FormData();
                formData.append('config', input.files[0]);

                fetch('/api/config/upload', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            htmx.trigger('#serverList', 'load');
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error uploading config: ' + error);
                    });
            }
        }

        function showAddBlockModal(serverId) {
            document.getElementById('blockServerId').value = serverId;
            document.getElementById('addBlockForm').reset();
            addBlockModal.show();
        }

        function showAddRegisterModal(serverId) {
            document.getElementById('registerServerId').value = serverId;
            document.getElementById('addRegisterForm').reset();
            updateAddressRange();
            updateFormatOptions();
            addRegisterModal.show();
        }

        function addBlock() {
            const serverId = document.getElementById('blockServerId').value;
            const type = document.getElementById('blockType').value;
            const startAddress = parseInt(document.getElementById('blockStartAddress').value);
            const length = parseInt(document.getElementById('blockLength').value);

            if (isNaN(startAddress) || isNaN(length)) {
                alert('Please fill in all fields');
                return;
            }

            // Calculate the actual Modbus address based on block type
            let address = startAddress;
            switch (type) {
                case 'discrete':
                    address += 10000;
                    break;
                case 'input':
                    address += 30000;
                    break;
                case 'holding':
                    address += 40000;
                    break;
            }

            const block = {
                type,
                startAddress: address,
                length,
                registers: []
            };

            // Get current server configuration
            fetch(`/api/servers/config/${serverId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    registerBlocks: [block]
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addBlockModal.hide();
                    htmx.trigger('#serverList', 'load');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error adding block: ' + error);
            });
        }

        function addRegister() {
            const serverId = document.getElementById('registerServerId').value;
            const type = document.getElementById('registerType').value;
            const name = document.getElementById('registerName').value;
            const baseAddress = parseInt(document.getElementById('registerAddress').value);
            const format = document.getElementById('registerFormat').value;

            if (!name || isNaN(baseAddress)) {
                alert('Please fill in all fields');
                return;
            }

            let size = 1;
            if (format === 'float') {
                size = 2;
            }

            // Calculate the actual Modbus address based on register type
            let address = baseAddress;
            switch (type) {
                case 'discrete':
                    address += 10000;
                    break;
                case 'input':
                    address += 30000;
                    break;
                case 'holding':
                    address += 40000;
                    break;
            }

            const register = {
                name,
                address,
                format,
                type
            };

            // Get current server configuration first and then add the new register
            fetch(`/api/servers/config/${serverId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                
            })
            .then(response => response.json())
            .then(data => {
                if (data.registerBlocks) {
                    const existingConfig = data;

                    // check if the register is already in the range of any block
                    let found = false;
                    for (const block of existingConfig.registerBlocks) {
                        if (address >= block.startAddress && address <= block.startAddress + block.length - 1) {
                            // add the register to the block
                            // check for null registers
                            if (block.registers === null) {
                                block.registers = [];
                            }
                            block.registers.push(register);
                            found = true;
                            break;
                        }
                    }

                    // if the register is not in the range of any block, add a new block
                    if (!found) {
                        existingConfig.registerBlocks.push({
                            type,
                            startAddress: address,
                            length: size,
                            registers: [register]
                        });
                    }

                    // Update the server configuration
                    fetch(`/api/servers/config/${serverId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(existingConfig)
                    })
                    htmx.trigger('#serverList', 'load');
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error adding register: ' + error);
            });
        }

        function showBulkAddModal(serverId) {
            document.getElementById('bulkAddServerId').value = serverId;
            document.getElementById('bulkAddForm').reset();
            document.getElementById('bulkAddType').value = 'holding';
            updateBulkAddFormatOptions();
            bulkAddModal.show();
        }

        function updateBulkAddFormatOptions() {
            const type = document.getElementById('bulkAddType').value;
            const format = document.getElementById('bulkAddFormat');
            
            // Reset options
            format.innerHTML = '';
            
            if (type === 'coil' || type === 'discrete') {
                // For coils and discrete inputs, only boolean format makes sense
                format.innerHTML = '<option value="boolean">Boolean</option>';
            } else {
                // For input and holding registers, all formats are available
                format.innerHTML = `
                    <option value="decimal">Decimal</option>
                    <option value="hex">Hexadecimal</option>
                    <option value="float">Float</option>
                    <option value="boolean">Boolean</option>
                `;
            }
        }

        function processBulkAdd() {
            const serverId = document.getElementById('bulkAddServerId').value;
            const text = document.getElementById('bulkAddText').value;
            const lines = text.split('\n').filter(line => line.trim());
            const type = document.getElementById('bulkAddType').value;
            const defaultFormat = document.getElementById('bulkAddFormat').value;
            let lastAddress = -1;
            let registers = [];

            for (const line of lines) {
                const parts = line.split(',').map(part => part.trim());
                if (parts.length < 1) continue;

                const name = parts[0];
                let address = parts.length > 1 && parts[1] ? parseInt(parts[1]) : lastAddress + 1;
                const format = parts.length > 2 ? parts[2] : defaultFormat;

                let size = 1;
                if (format === 'float') {
                    size = 2;
                }

                if (!name || isNaN(address)) {
                    alert(`Invalid line: ${line}`);
                    continue;
                }

                lastAddress = address + size - 1;

                // Calculate the actual Modbus address based on register type
                switch (type) {
                    case 'discrete':
                        address += 10000;
                        break;
                    case 'input':
                        address += 30000;
                        break;
                    case 'holding':
                        address += 40000;
                        break;
                }



                registers.push({
                    name,
                    address,
                    format,
                    type
                });
            }

            if (registers.length === 0) {
                alert('No valid registers to add');
                return;
            }

            // Get current server configuration first and then add the new registers
            fetch(`/api/servers/config/${serverId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.registerBlocks) {
                    // Add the new registers to the existing configuration
                    const existingConfig = data;

                    // find last address in the 

                    existingConfig.registerBlocks.push({
                        type,
                        startAddress: registers[0].address,
                        length: lastAddress-registers[0].address+1,
                        registers: registers
                    });

                    // Update the server configuration
                    fetch(`/api/servers/config/${serverId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            registerBlocks: [{
                                type,
                                startAddress: registers[0].address,
                                length: registers[registers.length-1].address+registers[registers.length-1].size,
                                registers: registers
                            }]
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            bulkAddModal.hide();
                            htmx.trigger('#serverList', 'load');
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error adding registers: ' + error);
                    });
                }
            });
        }

        function toggleServerTable(serverId) {
            const content = document.getElementById(`server-content-${serverId}`);
            const icon = document.getElementById(`toggle-icon-${serverId}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
            }
        }
    </script>
</body>

</html>